name: Download and Commit Audios

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0" # Runs weekly on Sunday at 3 AM UTC

jobs:
  download-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget rsync python3-pandas

      - name: Download/update audios and images (incremental)
        run: |
          mkdir -p apps_audio
          TMPDIR=$(mktemp -d)
          cd "$TMPDIR"
          wget -r -np -nH --cut-dirs=1 -R "index.html*" https://ya-mahdi.net/apps_audio/
          rsync -av --delete --exclude='index.html*' ./apps_audio/ "${GITHUB_WORKSPACE}/apps_audio/"
          cd "${GITHUB_WORKSPACE}"
          rm -rf "$TMPDIR"

      - name: Generate CSV mapping file
        run: |
          python3 <<'EOF'
          import os, csv

          base_url = "https://ya-mahdi.net/apps_audio/"
          github_repo = "https://github.com/${{ github.repository }}/blob/main/apps_audio/"
          raw_repo = "https://raw.githubusercontent.com/${{ github.repository }}/main/apps_audio/"
          cdnjs_prefix = "https://cdnjs.cloudflare.com/ajax/libs/"

          csv_file = "audio_links.csv"
          rows = []

          for root, _, files in os.walk("apps_audio"):
              for f in files:
                  if f.lower().endswith(('.mp3', '.m4a', '.png', '.jpg', '.jpeg')):
                      full_path = os.path.join(root, f)
                      rel_path = os.path.relpath(full_path, "apps_audio")
                      size_mb = os.path.getsize(full_path) / (1024 * 1024)
                      original_url = base_url + rel_path.replace("\\", "/")

                      if size_mb < 20:
                          github_url = github_repo + rel_path.replace("\\", "/")
                          cdn_url = cdnjs_prefix + rel_path.replace("\\", "/")
                      else:
                          github_url = raw_repo + rel_path.replace("\\", "/")
                          cdn_url = github_url  # same for >20MB

                      rows.append([original_url, github_url, cdn_url, f"{size_mb:.2f} MB"])

          with open(csv_file, "w", newline="", encoding="utf-8") as f:
              writer = csv.writer(f)
              writer.writerow(["Original URL", "GitHub URL", "CDNJS/Raw URL", "File Size"])
              writer.writerows(rows)
          EOF

      - name: Commit and push changes in batches of 20
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BATCH_SIZE=20            # Push after every 20 files
          MAX_DIRECT_MB=500        # Threshold to treat extremely large files specially (MB). Adjust if needed.

          # Gather changed/untracked files under apps_audio
          mapfile -t changed < <(git status --porcelain --untracked-files=all -- apps_audio | awk '{print $2}')

          # Include audio_links.csv in changed list if it's modified or untracked
          if [ -f audio_links.csv ]; then
            if ! git diff --quiet --exit-code -- audio_links.csv 2>/dev/null || [ -n "$(git ls-files --others --exclude-standard audio_links.csv)" ]; then
              changed+=("audio_links.csv")
            fi
          fi

          if [ ${#changed[@]} -eq 0 ]; then
            echo "No changes detected."
            exit 0
          fi

          echo "Total changed files: ${#changed[@]}"

          # Partition into batches of BATCH_SIZE and push after each batch
          i=0
          total=${#changed[@]}
          while [ $i -lt $total ]; do
            batch=()
            end=$(( i + BATCH_SIZE ))
            if [ $end -gt $total ]; then
              end=$total
            fi

            for ((j=i; j<end; j++)); do
              f="${changed[j]}"
              # Skip empty entries
              if [ -z "$f" ]; then
                continue
              fi
              # If file doesn't exist (deleted), still add to git so deletion is recorded
              batch+=("$f")
            done

            if [ ${#batch[@]} -eq 0 ]; then
              i=$end
              continue
            fi

            echo "Adding and committing batch files $((i+1))..${end} (count ${#batch[@]})"
            git add -- "${batch[@]}" || true
            git commit -m "Update audio files (batch $((i / BATCH_SIZE + 1))) - ${i}..$((end - 1))" || echo "No changes to commit in this batch"
            # Push after each batch to reduce rate-limit impact of one large push
            git push origin HEAD || echo "Push failed for batch $((i / BATCH_SIZE + 1)) â€” continuing"

            i=$end
          done

          echo "All batches processed."

          # Ensure audio_links.csv is committed if it wasn't included already
          if git ls-files --error-unmatch audio_links.csv >/dev/null 2>&1; then
            if ! git diff --quiet --exit-code -- audio_links.csv || [ -n "$(git ls-files --others --exclude-standard audio_links.csv)" ]; then
              echo "Ensuring audio_links.csv is committed"
              git add audio_links.csv
              git commit -m "Update audio_links.csv" || echo "No changes to commit for CSV"
              git push origin HEAD || echo "Push failed for audio_links.csv"
            fi
          fi

          echo "Incremental push complete."
